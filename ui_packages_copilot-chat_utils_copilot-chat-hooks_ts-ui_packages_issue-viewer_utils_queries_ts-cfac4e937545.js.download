"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["ui_packages_copilot-chat_utils_copilot-chat-hooks_ts-ui_packages_issue-viewer_utils_queries_ts"],{64916:(e,t,s)=>{s.d(t,{Z:()=>c});var r=s(28784),a=s(97665),n=s(97286),i=s(96540),o=s(89426),l=s(57938);function c(){let e=(0,a.jE)(),t=(0,i.useCallback)(()=>e.invalidateQueries({queryKey:["copilot-chat","entitlement"]}),[e]),{data:s}=(0,n.I)({queryKey:["copilot-chat","entitlement"],queryFn:async()=>{if(!l.W.copilotFreeLimitedUser)return{licenseType:o.mF.Unknown};let e=await (0,r.lS)("/github-copilot/chat/entitlement");if(!e.ok)throw Error(`Failed to retrieve Copilot chat entitlement (${e.status} on ${e.url})`);return await e.json()},placeholderData:{licenseType:o.mF.Unknown},staleTime:3e5}),c=(0,i.useCallback)(()=>{l.W.copilotFreeLimitedUser&&s?.licenseType===o.mF.LicensedLimited&&t()},[s?.licenseType,t]);return[new CopilotChatEntitlement(s?.licenseType??o.mF.Unknown,s?.quotas),t,c]}let CopilotChatEntitlement=class CopilotChatEntitlement{isLicensed(){return this.licenseType&&this.licenseType!==o.mF.Unknown&&this.licenseType!==o.mF.Unlicensed}chatQuotaRemaining(){return this.quotas?.remaining.chat??0}constructor(e,t){this.licenseType=e,this.quotas=t}}},33067:(e,t,s)=>{s.d(t,{Ld:()=>m,M8:()=>_,Tz:()=>T,U2:()=>E,W5:()=>u,cx:()=>g,o6:()=>S,r_:()=>y,vn:()=>f,xG:()=>h});var r=s(28784),a=s(97665),n=s(40458),i=s(94747),o=s(97286),l=s(96540),c=s(88365),d=s(61053);s(91078);var u=function(e){return e.Unindexed="not_indexed",e.Indexed="indexed",e.Indexing="indexing",e.PartiallyIndexed="partially_indexed",e.Unknown="unknown",e}({}),h=function(e){return e.Requested="requested",e.NotFound="not_found",e.Unauthorized="unauthorized",e.ServiceUnavailable="service_unavailable",e.QuotaExhausted="quota_exhausted",e.Forbidden="forbidden",e.CanIndex="ok",e.IndexingError="indexing_error",e.RequestFailed="request_failed",e.Unknown="unknown",e}({});let p=["not_found","unauthorized","service_unavailable","quota_exhausted","forbidden","request_failed"],g=256,m=400;function E(e,t,s){let r=(0,l.useRef)(void 0),a=(0,l.useRef)(void 0),n=(0,l.useRef)([]),i=(0,l.useRef)(!1),[o,c]=(0,l.useState)([]),[d,u]=(0,l.useState)(!0),h=(0,l.useCallback)(()=>{c([]),u(!1)},[]),p=(0,l.useCallback)(()=>{if(s&&e)try{let e=new Worker(s);e.onmessage=({data:e})=>{i.current=!1,c(e.list),u(!1),a.current=e.query,n.current=e.list},r.current=e}catch(e){console.warn("Web workers are not available: ",e)}},[s,e]),g=(0,l.useCallback)(t=>{i.current&&(r.current?.terminate(),p());let s=a.current&&t.startsWith(a.current)&&n.current.length;u(!0),i.current=!0,r.current?.postMessage({baseList:s?n.current:e,query:t})},[e,p]);return((0,l.useEffect)(()=>(p(),()=>r.current?.terminate()),[p]),(0,l.useEffect)(()=>{g(t)},[t,g]),s)?[o,d,h]:[[],!1,()=>{}]}function _(e){var t,s;let r=(0,a.jE)(),o=(0,l.useCallback)(()=>Promise.all(e.map(e=>r.invalidateQueries({queryKey:["copilot-chat","repos-indexing-state",e]}))),[r,e]),c=(0,n.E)({queries:e.map(e=>({queryKey:["copilot-chat","repos-indexing-state",e],queryFn:()=>w(e),placeholderData:{requestStatus:"unknown",code:"unknown",docs:"unknown"},staleTime:1/0}))}),{mutate:d}=(0,i.n)({mutationKey:["repos-indexing-state"],mutationFn:()=>C(e),onSuccess:o}),u={requestStatus:0===(s=(t=c.map(e=>e.data)).map(e=>e.requestStatus)).length?"unknown":s.some(e=>p.includes(e))?"indexing_error":s.every(e=>"ok"===e)?"ok":(s.every(e=>"unknown"===e),"unknown"),code:v(t.map(e=>e.code)),docs:v(t.map(e=>e.docs)),remainingRepoIndexTokens:t[0]?.remainingRepoIndexTokens};return I(()=>void o(),"indexing"===u.code&&"indexing_error"!==u.requestStatus?1e4:0),[u,()=>d()]}function f(e){let t=(0,a.jE)(),s=(0,l.useCallback)(()=>Promise.resolve(t.invalidateQueries({queryKey:["repo-indexing-state",e]})),[t,e]),r=(0,o.I)({queryKey:["copilot-chat","repo-indexing-state",e],queryFn:()=>w(e),placeholderData:{requestStatus:"unknown",code:"unknown",docs:"unknown"},staleTime:1/0}),{mutate:n}=(0,i.n)({mutationKey:["repo-indexing-state"],mutationFn:()=>C([e]),onSuccess:s}),c=r.data;return I(()=>void s(),"indexing"===c.code&&"indexing_error"!==c.requestStatus?1e4:0),[c,()=>n()]}function y(e){let t=(0,o.I)({queryKey:["copilot-chat","repos-indexing-state",e],queryFn:()=>R(e),staleTime:1/0});return!t.isError&&!!t.data?.canChat}function T(){let e=c.J.getPanelHeight(),t=c.J.getPanelWidth(),s=(0,l.useRef)(null),r=(0,l.useRef)(e),a=(0,l.useRef)(e),n=(0,l.useRef)(null),i=(0,l.useRef)(t),o=(0,l.useRef)(t),[d,u]=(0,l.useState)(e),[h,p]=(0,l.useState)(t),E=(0,l.useRef)(0);(0,l.useEffect)(()=>{E.current=parseFloat(getComputedStyle(document.documentElement).fontSize)},[]);let _=e=>Math.min(Math.max(e,g),window.innerHeight-E.current),f=e=>Math.min(Math.max(e,m),window.innerWidth-2*E.current),y=(0,l.useCallback)(e=>{if(null!==s.current){let t=s.current-e.clientY,n=_(r.current+t);u(n),a.current=n}if(null!==n.current){let t=n.current-e.clientX,s=f(i.current+t);p(s),o.current=s}},[]),T=(0,l.useCallback)(()=>{window.removeEventListener("mousemove",y),window.removeEventListener("mouseup",T),null!==s.current&&(c.J.setPanelHeight(a.current),s.current=null),null!==n.current&&(c.J.setPanelWidth(o.current),n.current=null)},[y]),S=(0,l.useCallback)((e,t,a)=>{0===e.button&&(e.preventDefault(),a&&(s.current=e.clientY,r.current=d),t&&(n.current=e.clientX,i.current=h),window.addEventListener("mousemove",y),window.addEventListener("mouseup",T))},[d,h,y,T]),w=(0,l.useCallback)(e=>{if("ArrowUp"===e.key){let t=_(d+4);u(t),c.J.setPanelHeight(t),e.preventDefault()}else if("ArrowDown"===e.key){let t=_(d-4);u(t),c.J.setPanelHeight(t),e.preventDefault()}else if("ArrowRight"===e.key){let t=f(h-4);p(t),c.J.setPanelWidth(t),e.preventDefault()}else if("ArrowLeft"===e.key){let t=f(h+4);p(t),c.J.setPanelWidth(t),e.preventDefault()}},[d,h]);return{panelWidth:h,panelHeight:d,startResize:S,onResizerKeyDown:w}}function S(e){let[t,s]=(0,l.useState)({}),r=(0,d.qY)();return(0,l.useEffect)(()=>{e&&(r?.current?.clientWidth||480)+480>=window.innerWidth?s({left:`${window.innerWidth-(r?.current?.clientWidth||480)}px !important`,bottom:"64px"}):s({})},[e,r]),t}async function w(e){let t=await fetch(`/search/check_indexing_status?nwo=${encodeURIComponent(e)}`,{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(!t.ok)return{requestStatus:"request_failed",code:"unknown",docs:"unknown"};let s=await t.json();return{requestStatus:s.can_index,code:s.code_status,docs:s.docs_status,remainingRepoIndexTokens:s.remaining_repo_index_tokens}}async function C(e){let t=1===e.length?`nwo=${encodeURIComponent(e[0])}`:`nwos=${encodeURIComponent(JSON.stringify(e))}`;return(0,r.DI)(`/search/index_embeddings?${t}&index_code=true`,{method:"POST"})}async function R(e){let t=await fetch(`/github-copilot/docs/docsets/kb_indexed_repos?ids=${encodeURIComponent(JSON.stringify(e))}`,{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});return t.ok?await t.json():{canChat:!1}}function v(e){return e.every(e=>"indexed"===e)?"indexed":e.every(e=>"not_indexed"===e)?"not_indexed":e.some(e=>"indexing"===e)?"indexing":e.some(e=>"not_indexed"===e)?"partially_indexed":"unknown"}function I(e,t){let s=(0,l.useRef)(void 0),r=(0,l.useRef)(e);return(0,l.useEffect)(()=>{r.current=e},[e]),(0,l.useEffect)(()=>{if(t>0)return s.current=window.setInterval(()=>r.current(),t),()=>window.clearInterval(s.current)},[t]),s}},87352:(e,t,s)=>{s.d(t,{AG:()=>g,SL:()=>p,e8:()=>CopilotChatManager});var r=s(25962),a=s(51848),n=s(28784),i=s(76206),o=s(18834),l=s(36824),c=s(89426),d=s(57938),u=s(88365),h=s(32645);let p="copilot_delete_all_conversations",g="copilot_staff_prompt_dialog",m=null;let CopilotChatManager=class CopilotChatManager{async openChat(e,t,s,r,a){if(this.dispatch({type:"OPEN_COPILOT_CHAT",source:s}),"thread"===t&&await this.findOrStartNewThread(e,a),u.J.setCollapsedState(!1),T(!0),r){let e=new FormData;e.set("copilot_chat_visible","true"),(0,n.DI)(r,{method:"PUT",body:e})}}closeChat(){this.dispatch({type:"CLOSE_COPILOT_CHAT"}),u.J.setCollapsedState(!0),T(!1)}hideChat(e){if(this.dispatch({type:"HIDE_COPILOT_CHAT"}),this.closeChat(),e){let t=new FormData;t.set("copilot_chat_visible","false"),(0,n.DI)(e,{method:"PUT",body:t})}}toggleRepoCustomInstructions(e){this.dispatch({type:"TOGGLE_REPO_CUSTOM_INSTRUCTIONS",value:e}),u.J.setRepoCustomInstructionsState(e)}viewAllThreads(){this.dispatch({type:"VIEW_ALL_THREADS"})}viewCurrentThread(){this.dispatch({type:"VIEW_CURRENT_THREAD"})}async sendChatMessage(e,t,s,r,a,n,o,l,d){let u=(0,i.P)(r),h=u?void 0:r;return u&&!s.some(e=>"docset"===e.type&&e.name===r.name)&&s.push({type:"docset",name:r.name,id:r.id,avatarUrl:r.avatarUrl,repos:r.repos,description:r.description}),this.sendNewMessage(e,t,c.wh.conversation,s,h,a,n,o,l,d)}async retryLastChatMessage(e){let{currentTopic:t,context:s,customInstructions:r,model:a}=this.getChatState(),n=(0,i.P)(t)?void 0:t;return this.resendLastMessage(e,s,n,r,a)}async stopStreaming(){let{streamer:e}=this.getChatState();e&&(await e.stop(),this.dispatch({type:"MESSAGE_STREAMING_STOPPED"}))}async getSystemPrompt(){let{mode:e}=this.getChatState();return await this.systemPrompt(e)}async sendNewMessage(e,t,s,r,a,n,o,l,c,d){let h=(0,i.Y6)({role:"user",content:t,references:r,thread:e,confirmations:o?[o]:[]});if(this.dispatch({type:"MESSAGE_ADDED",message:h,repoHasCustomInstructions:!!a?.customInstructions,usedRepoCustomInstructions:!!(a?.customInstructions&&this.repoInstructionsEnabled())}),!e){let t=await this.service.createThread();if(t.ok)e=t.payload,u.J.migrateNullThreadToNewThread(e.id),this.dispatch({type:"THREAD_CREATED",thread:e});else{this.handleSendMessageError(e,f(t.error));return}}return this.dispatch({type:"THREAD_UPDATED",thread:{...e,updatedAt:new Date().toISOString()}}),this.unstickyReferencesFeatureEnabled&&this.dispatch({type:"CLEAR_REFERENCES",threadID:e.id}),c&&u.J.setModel(e.id,c),this.sendMessage(e,t,r,s,n,a,l,c,o,d)}async resendLastMessage(e,t,s,r,a){let n=this.getChatState().messages.findLast(e=>"user"===e.role);if(!n||!n.content)return;let i=e.currentReferences||[];return this.dispatch({type:"MESSAGES_CLEAR_ERRORS"}),this.sendMessage(e,n.content,i,c.wh.conversation,t,s,r,a)}async sendMessage(e,t,s,r,n,l,c,d,u,h){let p=(0,i.Y6)({role:"assistant",content:"",thread:e});this.dispatch({type:"WAITING_ON_COPILOT",loading:!0});let g=s.length&&(1!==s.length||s[0]?.type!=="repository")?void 0:n;(0,a.BI)("copilot.implicit_context",{usedImplicitContext:!!g,type:g?.[0]?.type,count:g?.length}),!s.length&&l&&(s=[(0,i.qS)(l)]);let m=[];l?.customInstructions&&this.repoInstructionsEnabled()&&m.push(l.customInstructions),c&&m.push(c);let{mode:E}=this.getChatState();this.timings={startTime:Date.now()};let _=await this.service.createMessageStreaming(e.id,t,r,E,s,g??[],u?[u]:[],m,d?.id,h);if(!_.ok){this.handleSendMessageError(e,f(_.error));return}let y=_.response.body?.getReader();if(!y){this.handleSendMessageError(e,f(i.DW));return}let T=new o.X(y);this.dispatch({type:"MESSAGE_STREAMING_STARTED",message:p,streamer:T}),await this.handleStreamingMessage(e,T,g)}repoInstructionsEnabled(){return d.W.repoCustomInstructions&&u.J.getRepoCustomInstructionsState()}addReference(e,t){this.dispatch({type:"ADD_REFERENCE",reference:e,source:t})}removeReference(e){this.dispatch({type:"REMOVE_REFERENCES",referenceIndexes:[e]})}removeReferences(e){this.dispatch({type:"REMOVE_REFERENCES",referenceIndexes:e})}selectModel(e){this.dispatch({type:"SELECT_MODEL",model:e}),u.J.setModel(this.getChatState().selectedThreadID,e)}setCopilotSettings(e){u.J.settings=e}async dismissAttachKnowledgeBaseHerePopover(){this.dispatch({type:"DISMISS_ATTACH_KNOWLEDGE_BASE_HERE_POPOVER"}),await (0,n.DI)("/settings/dismiss-notice/copilot_for_docs_attach_knowledge_base_here",{method:"POST"})}async dismissKnowledgeBaseAttachedToChatPopover(){this.dispatch({type:"DISMISS_KNOWLEDGE_BASE_ATTACHED_TO_CHAT_POPOVER"}),await (0,n.DI)("/settings/dismiss-notice/copilot_for_docs_knowledge_base_attached_to_chat",{method:"POST"})}async selectThread(e,t){let{clearTopic:s,includeThreads:r=!0}=t??{};await this.fetchModels(),await this.stopStreaming(),this.dispatch({type:"SELECT_THREAD",thread:e,clearTopic:s});let a=[];a.push(this.fetchMessages(e?.id||null)),r&&a.push(this.fetchThreads()),await Promise.all(a)}addMessage(e,t,s,r){let a=(0,i.Y6)({role:e,content:s,references:r,thread:t});this.dispatch({type:"MESSAGE_ADDED",message:a})}async renameThread(e,t){(await this.service.renameThread(e.id,t)).ok&&this.dispatch({type:"THREAD_UPDATED",thread:{...e,name:t}})}async clearThread(e){(await this.service.clearThread(e.id)).ok&&this.dispatch({type:"CLEAR_THREAD",threadID:e.id})}async deleteThreadKeepSelection(e){this.dispatch({type:"DELETE_THREAD_KEEP_SELECTION",thread:e});let t=await this.service.deleteThread(e.id);t.ok||this.dispatch({type:"DELETE_THREAD_ERROR",thread:e,error:t.error})}async deleteAllThreadKeepSelection(e){this.dispatch({type:"DELETE_ALL_THREADS_KEEP_SELECTION",threads:e});let t=e.map(e=>e.id);for(let s=0;s<t.length;s+=100){let r=t.slice(s,s+100),a=await this.service.deleteAllThreads({threadIDs:r});a.ok||this.dispatch({type:"DELETE_ALL_THREADS_ERROR",threads:e,error:a.error})}}async deleteThread(e){this.dispatch({type:"DELETE_THREAD",thread:e});let t=await this.service.deleteThread(e.id);t.ok||this.dispatch({type:"DELETE_THREAD_ERROR",thread:e,error:t.error})}async generateSuggestions(e,t){let s=null;if(t){let r=await this.service.generateSuggestions(e,t);r.ok&&(s=r.payload)}else{let t="type"in e&&"string"==typeof e.type?e.type:"repository";s=(0,i.mx)(t)}this.dispatch({type:"SUGGESTIONS_GENERATED",suggestions:s})}clearSuggestions(){this.dispatch({type:"CLEAR_SUGGESTIONS"})}async handleOpenPanelEvent(e,t,s){let n=t.payload;if(E(n)||_(n,[c.wh.conversation])&&"newThread"in n&&n.newThread?(await this.selectThread(null),e=null):_(n,[c.wh.reviewPr])?(this.addMessage("user",n.thread,r.Bc,n.references),this.addMessage("assistant",n.thread,n.completion,n.references),this.selectThread(n.thread,{includeThreads:!1})):e=await this.findOrStartNewThread(e),this.dispatch({type:"HANDLE_EVENT_START",references:n.references,id:n.id}),_(n,[c.wh.conversation,c.wh.discussFileDiff,c.wh.reviewPr])&&!E(n))return;let o=`blob ${n.intent}`;n.id&&(o=`element ${t.payload.id}`),(0,a.BI)("copilot.open_copilot_chat",{source:o}),await this.sendNewMessage(e,n.content,n.intent,n.references??[],(0,i.Z6)(s)?s:void 0)}async handleSearchCopilotEvent(e){let t=await this.fetchCurrentRepo(e.repoNwo),s=t?[{type:"repository",...t}]:[];this.openChat(null,"thread","search-bar"),await this.sendNewMessage(null,e.content,c.wh.conversation,s),(0,a.BI)("copilot.open_copilot_chat",{source:"search-bar"})}async handleAddReferenceEvent(e){await this.findOrStartNewThread(),this.addReference(e.reference,"event"),e.openPanel&&this.dispatch({type:"OPEN_COPILOT_CHAT",source:"event",id:e.id})}handleSymbolChangedEvent(e){let t=e.context;this.dispatch({type:"IMPLICIT_CONTEXT_UPDATED",context:[t]})}getSelectedThread(e){return e.selectedThreadID&&e.threads.get(e.selectedThreadID)||null}sortThreads(e){return Array.from(e.values()).sort((e,t)=>new Date(t.updatedAt).getTime()-new Date(e.updatedAt).getTime())}async sendMessageToNewThread(e,t,s,r){""!==t.trim()&&(e&&(u.J.setSavedMessageFast(e,null),u.J.clearCurrentReferences(e)),await this.sendNewMessage(null,t,c.wh.conversation,s,void 0,r))}async fetchMessages(e){let t=u.J.getCurrentReferences(e);if(!e){this.threadDataLoaded([],t||[]);return}this.dispatch({type:"MESSAGES_UPDATED",state:"loading"});let s=await this.service.listMessages(e);if(s.ok){let e=s.payload.thread;this.threadDataLoaded(s.payload.messages,t||e.currentReferences||[])}else this.dispatch({type:"MESSAGES_UPDATED",state:"error"})}selectReference(e){this.dispatch({type:"SELECT_REFERENCE",reference:e})}setTopRepositoryTopics(e){this.dispatch({type:"SET_TOP_REPOSITORIES",topics:e})}async handleStreamingMessage(e,t,s){try{for await(let r of t.stream())await this.processStreamingMessage(e,r,s)}catch(s){let t=this.isWrappedStreamingResponseError(s)?this.getStreamingErrorMessage(s.error):f(i.DW);this.handleSendMessageError(e,t);return}}isWrappedStreamingResponseError(e){return!!e&&"object"==typeof e&&"error"in e&&!!e.error&&"object"==typeof e.error&&"errorType"in e.error&&"string"==typeof e.error.errorType&&c.C6.includes(e.error.errorType)}async processStreamingMessage(e,t,s){var r,a,n;switch((r=this.timings).firstByte??(r.firstByte=Date.now()),t.type){case"content":(a=this.timings).firstToken??(a.firstToken=Date.now()),this.dispatch({type:"MESSAGE_STREAMING_TOKEN_ADDED",token:t.body});break;case"functionCall":n=t.name,(c.xP.includes(n)||d.W.issueCreation&&"githubissuecreate"===n)&&this.dispatch({type:"MESSAGE_STREAMING_FUNCTION_CALLED",name:t.name,status:t.status,arguments:t.arguments,errorMessage:t.errorMessage,references:t.references});break;case"confirmation":this.dispatch({type:"MESSAGE_STREAMING_CONFIRMATION",title:t.title,message:t.message,confirmation:t.confirmation});break;case"complete":this.dispatch({type:"MESSAGE_STREAMING_COMPLETED",messageResponse:t,timings:{...this.timings,endTime:Date.now()}}),await this.handleSendMessageSuccess(e),s&&s.length>0&&d.W.followUpThreadSuggestions&&await this.generateSuggestions(s[0],e.id);break;case"error":{let s=this.getStreamingErrorMessage(t);this.handleSendMessageError(e,s);break}case"debug":console.log("Prompt Body:",t.body);break;case"agentError":this.dispatch({type:"AGENT_ERROR",error:{type:t.agentErrorType,code:t.code,message:t.message,identifier:t.identifier}})}}getStreamingErrorMessage(e){switch(e.errorType){case"publicCode":{let e="https://docs.github.com/en/copilot/managing-copilot/managing-copilot-as-an-individual-subscriber/managing-copilot-policies-as-an-individual-subscriber",t=`This response cannot be shown because it references public code, which is restricted by [your Copilot settings](${e}).`;return this.hasCEorCBAccess&&(e="https://docs.github.com/en/enterprise-cloud@latest/copilot/managing-copilot/managing-github-copilot-in-your-organization/managing-policies-for-copilot-in-your-organization",t=`This response cannot be shown because it references public code, which is restricted by [your organization's Copilot settings](${e}).`),{type:"basic",isError:!0,message:t,retryable:!1}}case"filtered":return y(i.Sr[403]||i.DW);case"contentTooLarge":return y(i.Sr[413]||i.DW);case"rateLimit":return f(i.Sr[429]||i.DW);case"agentUnauthorized":{let t=JSON.parse(e.description);return{type:"agentUnauthorized",isError:!0,message:`You haven't authorized ${t.name} to access your account. You can do that by going here: ${window.location.origin}/login/oauth/authorize?client_id=${t.client_id}`,details:t}}case"agentRequest":{let t=JSON.parse(e.description);return{type:"agentRequest",isError:!0,message:t.message,details:t}}case"multipleAgentsAttempt":return f("Only one agent is allowed per thread, and their context can't be shared. If you want to interact with another agent, please start a new thread and @ mention the new agent.");case"networkError":return f(i.Sr[408]||i.DW);default:return f(i.DW)}}async handleSendMessageSuccess(e){u.J.setSavedMessageFast(e.id,null),u.J.clearCurrentReferences(e.id),this.dispatch({type:"WAITING_ON_COPILOT",loading:!1}),e=await this.generateThreadName(e),this.dispatch({type:"THREAD_UPDATED",thread:{...e,updatedAt:new Date().toISOString()}})}handleSendMessageError(e,t){let s=(0,i.Y6)({role:"assistant",content:"",error:t,thread:e});this.dispatch({type:"MESSAGE_ADDED",message:s}),this.dispatch({type:"WAITING_ON_COPILOT",loading:!1}),this.dispatch({type:"MESSAGE_STREAMING_FAILED"})}async fetchModels(){if(m){let{availableModels:e}=this.getChatState();(!e||m.length>e.length)&&this.dispatch({type:"MODELS_LOADED",models:m});return}this.dispatch({type:"MODELS_LOADING"});let e=await this.service.listModels();if(e.ok){let t=(0,h.e)(e.payload);m=t,this.dispatch({type:"MODELS_LOADED",models:t});let s=u.J.getModel(this.getChatState().selectedThreadID)?.id,r=t.find(e=>e.id===s);r&&this.dispatch({type:"SELECT_MODEL",model:r})}else this.dispatch({type:"MODELS_LOADING_ERROR",error:e.error})}async acceptModelPolicy(e){e.policy&&"enabled"!==e.policy.state&&(await this.service.setModelPolicyState(e.id,"enabled"),m=null,this.fetchModels())}async fetchThreads(){this.dispatch({type:"THREADS_LOADING"});let e=await this.service.fetchThreads();return e.ok?(setTimeout(()=>this.dispatch({type:"THREADS_LOADED",threads:e.payload}),100),e.payload):(setTimeout(()=>this.dispatch({type:"THREADS_LOADING_ERROR",message:e.error}),100),null)}async fetchLatestThread(e){let t=await this.service.fetchLatestThread(e);return t.ok?(t.payload&&this.dispatch({type:"LATEST_THREAD_LOADED",latestThread:t.payload}),t.payload):null}async findOrStartNewThread(e,t){let s=null;if(e)s=e;else{let e=u.J.selectedThreadID||void 0;s=await this.fetchLatestThread(e)}if(s&&(0,i.F2)(s)&&(s=null),s&&t){let e=await this.service.listMessages(s.id);if(e.ok){let r=e.payload.messages,a=r?.length;a>=2&&!r[a-2]?.references?.find(e=>i.x_(e,t))&&(s=null)}}return await this.selectThread(s,{includeThreads:!1}),s}async generateThreadName(e){if(e.name)return e;let t=await this.service.generateThreadName(e.id);return t.ok&&(e={...e,name:t.payload}),e}async systemPrompt(e){let t=await this.service.getSystemPrompt(e);return t.ok?t.payload.prompt:""}async fetchAgents(e){let t=await this.service.listAgents(e),s=[];return t.ok&&(s=t.payload,this.dispatch({type:"SET_AGENTS",agents:s})),s}async fetchCustomCopilots(){let e=await this.service.listCustomCopilots(),t=[];return e.ok&&(t=e.payload,this.dispatch({type:"SET_CUSTOM_COPILOTS",customCopilots:t})),t}async fetchCurrentRepo(e){this.dispatch({type:"CURRENT_TOPIC_UPDATED",topic:void 0,state:"loading"});let t=await this.service.fetchRepo(e);if(t.ok)return this.dispatch({type:"CURRENT_TOPIC_UPDATED",topic:t.payload,state:"loaded"}),t.payload;this.dispatch({type:"CURRENT_TOPIC_UPDATED",topic:void 0,state:"error"})}async fetchKnowledgeBases(){this.dispatch({type:"KNOWLEDGE_BASES_LOADING"});let e=await this.service.listDocsets();return e.ok?this.dispatch({type:"KNOWLEDGE_BASES_LOADED",knowledgeBases:e.payload}):this.dispatch({type:"KNOWLEDGE_BASES_LOADING_ERROR",message:e.error}),e}async fetchImplicitContext(e,t,s){let r=await this.service.fetchImplicitContext(e,t,s);if(r.ok){let e=r.payload?Array.isArray(r.payload)?r.payload:[r.payload]:void 0;this.dispatch({type:"IMPLICIT_CONTEXT_UPDATED",context:e})}}async deleteDocset(e){return(await this.service.deleteDocset(e)).ok}threadDataLoaded(e,t){this.dispatch({type:"MESSAGES_UPDATED",messages:e,state:"loaded"}),this.dispatch({type:"REFERENCES_LOADED",references:t})}dismissEditorUpsellBanner(){let e=new FormData;e.set("copilot_editor_upsell_banner_dismissed","true"),(0,n.DI)("/github-copilot/preferences",{method:"PUT",body:e}),this.dispatch({type:"DISMISS_EDITOR_UPSELL_BANNER"})}constructor(e,t,s,r,a,n,i){this.unstickyReferencesFeatureEnabled=d.W.unstickyReferences,this.timings={startTime:0},this.clearCurrentReferences=()=>{this.dispatch({type:"CLEAR_CURRENT_REFERENCES"})},this.clearCurrentTopic=()=>{this.dispatch({type:"CURRENT_TOPIC_UPDATED",topic:void 0,state:"loaded"})},this.showTopicPicker=(e=!0)=>{this.dispatch({type:"SHOW_TOPIC_PICKER",show:e})},this.dispatch=e,this.service=n??new l.k(t,s,a),this.getChatState=r,this.hasCEorCBAccess=!!i}};function E(e){var t;return _(e,[c.wh.explain,c.wh.suggest])||_(e,[c.wh.conversation])&&"content"in(t=e)&&"string"==typeof t.content}function _(e,t){return new Set(t).has(e.intent)}function f(e){return{isError:!0,message:e,type:"basic",retryable:!0}}function y(e){return{isError:!0,message:e,type:"basic",retryable:!1}}function T(e){let t=document.getElementById(r.fv);t?.setAttribute("aria-expanded",e?"true":"false")}},18834:(e,t,s)=>{s.d(t,{X:()=>CopilotChatMessageStreamer});let r=/^data:\s+/;let CopilotStreamingError=class CopilotStreamingError extends Error{constructor(e){super(e.description),this.error=e,this.name="CopilotStreamingError"}};let CopilotChatMessageStreamer=class CopilotChatMessageStreamer{async *stream(){let e=new TextDecoder("utf-8"),t="";for(;;){let s,a;try{({value:s,done:a}=await this.reader.read())}catch{throw new CopilotStreamingError({type:"error",errorType:"networkError",description:"NETWORK_CONNECTION_INTERRUPTED"})}if(a)break;for(t+=e.decode(s);;){let e=t.indexOf("\n\n");if(-1===e)break;let s=t.slice(0,e).replace(r,"");if("[DONE]"===s)return;let a=JSON.parse(s);if(yield a,a?.type==="complete")return;t=t.slice(e+2)}}}async stop(){return this.reader.cancel()}constructor(e){this.reader=e}}},57938:(e,t,s)=>{s.d(t,{W:()=>a});var r=s(97564);let a=new class CopilotFeatureFlags{get embedding(){return(0,r.G7)("copilot_conversational_ux_embedding_update")}get unstickyReferences(){return(0,r.G7)("copilot_conversational_ux_history_refs")}get implicitContext(){return(0,r.G7)("COPILOT_IMPLICIT_CONTEXT")}get issueCreation(){return(0,r.G7)("copilot_issue_creation")}get followUpThreadSuggestions(){return(0,r.G7)("copilot_chat_follow_up_thread_suggestions")}get customInstructions(){return(0,r.G7)("copilot_chat_custom_instructions")}get reactMarkdown(){return(0,r.G7)("copilot_react_markdown")}get dotcomUserServerTokens(){return(0,r.G7)("copilot_chat_dotcom_user_server_tokens")}get immersiveFilePreview(){return(0,r.G7)("copilot_immersive_file_preview")}get magicKBs(){return(0,r.G7)("copilot_chat_magic_kbs")}get bringYourOwnKey(){return(0,r.G7)("copilot_byok")}get newReferencesUI(){return(0,r.G7)("copilot_new_references_ui")}get improvedCodeBlocks(){return(0,r.G7)("copilot_chat_improved_code_blocks")}get repoCustomInstructions(){return(0,r.G7)("copilot_chat_repo_custom_instructions")}get copilotFreeLimitedUser(){return(0,r.G7)("copilot_free_limited_user")}get sharedTopicIndicator(){return(0,r.G7)("copilot_chat_shared_topic_indicator")}get copilotChatRetryOnError(){return(0,r.G7)("copilot_chat_retry_on_error")}get copilotChatPersistSubmittedInput(){return(0,r.G7)("copilot_chat_persist_submitted_input")}get customCopilots(){return(0,r.G7)("copilot_custom_copilots")}get bypassIndexingQuota(){return(0,r.G7)("bypass_copilot_indexing_quota")}get reduceTelemetry(){return(0,r.G7)("copilot_dotcom_chat_reduce_telemetry")}get editorUpsells(){return(0,r.G7)("copilot_editor_upsells")}get shareConversation(){return(0,r.G7)("copilot_share_conversation")}}},32645:(e,t,s)=>{s.d(t,{U:()=>i,e:()=>o});let r=["o1","o1-mini","o1-ga"],a="/images/modules/marketplace/models/families/openai.svg",n=new Map([["Azure OpenAI",a],["Anthropic","/images/modules/marketplace/models/families/anthropic.svg"],["Google","/images/modules/marketplace/models/families/gemini.svg"]]),i={capabilities:{family:"gpt-4o",limits:{max_prompt_tokens:2e4},supports:{parallel_tool_calls:!0,tool_calls:!0},tokenizer:"o200k_base",type:"chat"},id:"gpt-4o",name:"GPT 4o",version:"gpt-4o-2024-05-13",displayName:"GPT 4o",vendor:"Azure OpenAI",logoURL:a,hasLimitedCapabilities:!1,preview:!1,isThirdParty:!1,model_picker_enabled:!0};function o(e){return(e??[i]).map(l).filter(e=>!!e).filter(e=>e.model_picker_enabled)}function l(e){return"chat"===e.capabilities.type&&e.model_picker_enabled&&(!e.policy||"enabled"===e.policy.state||e.policy.terms)?{...e,displayName:function(e){for(let t of c)if(e.name.endsWith(t))return e.name.replace(t,"").trim();return e.name}(e),hasLimitedCapabilities:r.includes(e.capabilities.family),isThirdParty:"Azure OpenAI"!==e.vendor,logoURL:n.get(e.vendor)}:null}let c=["(Beta)","(Preview)"]},73766:(e,t,s)=>{s.d(t,{J:()=>r});function r(e){let t=e.indexOf("/");if(-1===t||0===t)return`${e} in:name archived:false`;let s=e.slice(0,t),r=e.slice(t+1);return 0===r.length?`org:${s} in:name archived:false`:`org:${s} ${r} in:name archived:false`}},34135:(e,t,s)=>{function r(e,t,s){if(!t.has(e))throw TypeError("attempted to "+s+" private field on non-instance");return t.get(e)}function a(e,t){var s=r(e,t,"get");return s.get?s.get.call(e):s.value}function n(e,t,s){!function(e,t){if(t.has(e))throw TypeError("Cannot initialize the same private elements twice on an object")}(e,t),t.set(e,s)}function i(e,t,s){var a=r(e,t,"set");return!function(e,t,s){if(t.set)t.set.call(e,s);else{if(!t.writable)throw TypeError("attempted to set read only private field");t.value=s}}(e,a,s),s}s.d(t,{Es:()=>ObservableMap,Lj:()=>ObservableValue,yy:()=>ObservableSet});var o=new WeakMap;let l=class ObservableBase{subscribe(e){return a(this,o).add(e),()=>{a(this,o).delete(e)}}notify(e){for(let t of a(this,o))t(e)}constructor(){n(this,o,{writable:!0,value:void 0}),i(this,o,new Set)}};var c=new WeakMap;let ObservableValue=class ObservableValue extends l{get value(){return a(this,c)}set value(e){var t;t=a(this,c),("object"==typeof e&&e&&"object"==typeof t&&t?function(e,t){for(let s of new Set(Object.keys(e).concat(Object.keys(t))))if(!Object.is(e[s],t[s]))return!0;return!1}(t,e):!Object.is(t,e))&&(i(this,c,e),this.notify(e))}constructor(e){super(),n(this,c,{writable:!0,value:void 0}),i(this,c,e)}};var d=new WeakMap,u=new WeakMap;let ObservableSet=class ObservableSet extends l{get value(){return a(this,d)}has(e){if(!a(this,u).has(e)){let t=new ObservableValue(a(this,d).has(e));a(this,u).set(e,t)}return a(this,u).get(e)}add(e){a(this,d).has(e)||(a(this,d).add(e),a(this,u).has(e)&&(a(this,u).get(e).value=!0),this.notify(a(this,d)))}delete(e){a(this,d).has(e)&&(a(this,d).delete(e),a(this,u).has(e)&&(a(this,u).get(e).value=!1),this.notify(a(this,d)))}clear(){if(0!==a(this,d).size){for(let e of(a(this,d).clear(),a(this,u).values()))e.value=!1;this.notify(a(this,d))}}constructor(...e){super(),n(this,d,{writable:!0,value:void 0}),n(this,u,{writable:!0,value:void 0}),i(this,u,new Map),i(this,d,new Set(...e))}};var h=new WeakMap,p=new WeakMap,g=new WeakMap;let ObservableMap=class ObservableMap extends l{get value(){return a(this,h)}has(e){if(!a(this,p).has(e)){let t=new ObservableValue(a(this,h).has(e));a(this,p).set(e,t)}return a(this,p).get(e)}get(e){if(!a(this,g).has(e)){let t=new ObservableValue(a(this,h).get(e));a(this,g).set(e,t)}return a(this,g).get(e)}set(e,t){a(this,h).get(e)!==t&&(a(this,h).set(e,t),a(this,p).has(e)&&(a(this,p).get(e).value=!0),a(this,g).has(e)&&(a(this,g).get(e).value=t),this.notify(a(this,h)))}delete(e){a(this,h).has(e)&&(a(this,h).delete(e),a(this,p).has(e)&&(a(this,p).get(e).value=!1),a(this,g).has(e)&&(a(this,g).get(e).value=void 0),this.notify(a(this,h)))}clear(){if(0!==a(this,h).size){for(let e of(a(this,h).clear(),a(this,p).values()))e.value=!1;for(let e of a(this,g).values())e.value=void 0;this.notify(a(this,h))}}constructor(...e){super(),n(this,h,{writable:!0,value:void 0}),n(this,p,{writable:!0,value:void 0}),n(this,g,{writable:!0,value:void 0}),i(this,p,new Map),i(this,g,new Map),i(this,h,new Map(...e))}}},32968:(e,t,s)=>{s.d(t,{AI:()=>n,HN:()=>l,R:()=>i,Rs:()=>o,Sk:()=>d,tQ:()=>c});var r=s(96540),a=s(34135);function n(e){let[t]=(0,r.useState)(()=>new a.Lj(e));return t}function i(...e){let[t]=(0,r.useState)(()=>new a.Es(...e));return t}function o(e,t){let s=(0,r.useRef)(t);(0,r.useEffect)(()=>{s.current=t}),(0,r.useEffect)(()=>e.subscribe(e=>s.current(e)),[e])}function l(e){let[t,s]=(0,r.useState)(e.value);return o(e,e=>s(e)),t}function c(e){let[t,s]=(0,r.useState)(e.value),[a,n]=(0,r.useState)({});return o(e,e=>{s(e),n({})}),t}function d(e,t){let s=n(t(e.value));return o(e,e=>{s.value=t(e)}),s}},6702:(e,t,s)=>{s.d(t,{$:()=>c,x:()=>d});var r=s(74848),a=s(64916),n=s(89426),i=s(57938),o=s(96540);let l=(0,o.createContext)(void 0);function c({children:e,mode:t}){let[s,c]=(0,a.Z)(),[d,u]=(0,o.useState)(!0);(0,o.useEffect)(()=>{(!i.W.copilotFreeLimitedUser||s)&&u(!1)},[s]);let h=i.W.copilotFreeLimitedUser?s?.licenseType??n.mF.Unlicensed:n.mF.LicensedFull,p="immersive"===t;(0,o.useEffect)(()=>{i.W.copilotFreeLimitedUser&&p&&!s.isLicensed()&&c()},[]);let g=i.W.copilotFreeLimitedUser?s?.chatQuotaRemaining()??1/0:1/0,m=i.W.copilotFreeLimitedUser&&s?.quotas?.resetDate?new Date(s.quotas.resetDate).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"",E=!!i.W.copilotFreeLimitedUser&&h===n.mF.LicensedLimited,_=!!i.W.copilotFreeLimitedUser&&E&&g<=0,f=(0,o.useMemo)(()=>({licenseType:h,chatQuotaRemaining:g,resetDate:m,isLicensedLimited:E,chatQuotaExceeded:_}),[h,g,m,E,_]),y=(h===n.mF.Unlicensed||h===n.mF.Unknown)&&p;return d||y?null:(0,r.jsx)(l.Provider,{value:f,children:e})}let d=()=>{let e=(0,o.useContext)(l);if(!e)throw Error("useEntitlement must be used within EntitlementProvider");return e};try{l.displayName||(l.displayName="EntitlementContext")}catch{}try{c.displayName||(c.displayName="EntitlementProvider")}catch{}},13369:(e,t,s)=>{s.d(t,{A:()=>l,c:()=>c});var r=s(74848),a=s(96540),n=s(76206);let CopilotAutocompleteManager=class CopilotAutocompleteManager{filenameFromPath(e){let t=e.split("/");return t[t.length-1]}async fetchAutocompleteSuggestions(e,t){let[s,r]=await Promise.all([this.manager.service.querySymbols(e,t),this.manager.service.listRepoFiles(e)]);if(s.ok){let t=s.payload.flatMap(t=>t.symbol?[(0,n.Qt)(t,e)]:[]);this.symbolSuggestions=new Map(t.map(e=>[e.name,e]))}if(this.repoFileSuggestions.has(e.name)){this.fileSuggestions=this.repoFileSuggestions.get(e.name);return}if(r.ok){let t=new Map;this.repoFileSuggestions.set(e.name,t);let s=0,a=()=>{let i=Math.min(s+5e3,r.payload.length);for(;s<i;s++){let a=r.payload[s];if(a){let s=(0,n.iW)(a,e);t.set(s.path,s)}}if(s<r.payload.length)setTimeout(a,0);else{this.fileSuggestions=t;return}};a()}}findReference(e,t){return t.currentReferences.find(t=>e===(0,n.Vb)(t))}async addToReferences(e,t){let s=(0,n.Vb)(e);if(this.findReference(s,t))return;let r=e;if((0,n.SI)(e)){let t=await this.manager.service.fetchLanguageForFileReference(e);if(t.ok&&t.payload.language){let{languageName:s,languageId:a}=t.payload.language;r={...e,languageName:s,languageId:a}}}this.manager.addReference(r,"autocomplete")}constructor(e){this.fileSuggestions=new Map,this.symbolSuggestions=new Map,this.knowledgeSuggestions=new Map,this.repoFileSuggestions=new Map,this.manager=e}};var i=s(91078);let o=(0,a.createContext)(null);function l({children:e}){let t=(0,i.b)(),s=(0,a.useMemo)(()=>new CopilotAutocompleteManager(t),[t]);return(0,r.jsx)(o.Provider,{value:s,children:e})}function c(){return(0,a.useContext)(o)}try{o.displayName||(o.displayName="CopilotChatAutocompleteContext")}catch{}try{l.displayName||(l.displayName="CopilotChatAutocompleteProvider")}catch{}},61053:(e,t,s)=>{s.d(t,{Jf:()=>D,Mj:()=>L,qY:()=>x,Pk:()=>b,pn:()=>N,A3:()=>k,bP:()=>P});var r=s(74848),a=s(32968),n=s(51884),i=s(51012),o=s(96540),l=s(18312),c=s(6702);let d=(0,s(74572).A)("sessionStorage");function u(e,t){return!!e&&"assistive"===t}let h="restored-chat-messages";var p=s(76206),g=s(51848),m=s(57938),E=s(88365);let _=(e,t)=>{let s=t=>{t&&(E.J.selectedThreadID=t);let s=E.J.getModel(t)?.id,r=e.availableModels?.find(e=>e.id===s)??e.model;return{...e,model:r,selectedThreadID:t,currentView:"thread",showTopicPicker:!t&&e.showTopicPicker}},r=t=>(E.J.setCurrentReferences(e.selectedThreadID,t),{...e,currentReferences:t});switch(t.type){case"SLASH_COMMANDS_ERROR":return(0,g.BI)("copilot.slash_commands_error"),{...e,slashCommandLoading:{...e.slashCommandLoading,state:"error"}};case"SLASH_COMMANDS_LOADED":return(0,g.BI)("copilot.slash_commands_loaded"),{...e,slashCommandLoading:{...e.slashCommandLoading,state:"loaded"}};case"SLASH_COMMANDS_LOADING":return m.W.reduceTelemetry||(0,g.BI)("copilot.slash_commands_loading"),{...e,slashCommandLoading:{...e.slashCommandLoading,state:"loading"}};case"OPEN_COPILOT_CHAT":return(0,g.BI)("copilot.open_copilot_chat",{source:t.source}),{...e,chatIsOpen:!0,chatIsVisible:!0,entryPointId:t.id};case"CLOSE_COPILOT_CHAT":return(0,g.BI)("copilot.close_copilot_chat"),{...e,chatIsOpen:!1};case"HIDE_COPILOT_CHAT":return(0,g.BI)("copilot.hide_copilot_chat"),{...e,chatIsVisible:!1};case"THREAD_CREATED":return(0,g.BI)("copilot.thread_created",{...y(t.thread),mode:e.mode,count:e.threads.size+1}),{...s(t.thread.id),threads:new Map(e.threads.set(t.thread.id,t.thread))};case"SUGGESTIONS_GENERATED":return{...e,suggestions:t.suggestions};case"CLEAR_SUGGESTIONS":return{...e,suggestions:null};case"CLEAR_THREAD":return(0,g.BI)("copilot.clear_thread"),{...e,messages:[],currentReferences:[]};case"CLEAR_REFERENCES":return m.W.reduceTelemetry||(0,g.BI)("copilot.clear_references"),{...e,currentReferences:e.currentReferences.filter(e=>"docset"===e.type||"magic-knowledge-base"===e.type)};case"CLEAR_CURRENT_REFERENCES":return(0,g.BI)("copilot.clear_current_references"),{...e,currentReferences:[]};case"MESSAGES_UPDATED":if("error"!==t.state&&m.W.reduceTelemetry||(0,g.BI)("copilot.messages_updated",{count:t.messages?.length,loading:t.state}),!t.messages)return{...e,messagesLoading:{...e.messagesLoading,state:t.state}};{let s=e.defaultRecipient,r=e.allClientConfirmations;return"loaded"===t.state&&t.messages.length>0&&(s=S(t.messages[t.messages.length-1],e),r=t.messages.map(e=>e.clientConfirmations?.map(e=>JSON.stringify(Object.values(e.confirmation).sort()))).flat().filter(Boolean)),{...e,defaultRecipient:s,allClientConfirmations:r,messages:t.messages,messagesLoading:{...e.messagesLoading,state:t.state},messagesRestored:!1}}case"WAITING_ON_COPILOT":return m.W.reduceTelemetry||(0,g.BI)("copilot.waiting_on_copilot",{isWaitingOnCopilot:t.loading}),{...e,isWaitingOnCopilot:t.loading};case"SELECT_THREAD":return(0,g.BI)("copilot.select_thread",{threadID:t.thread?.id,mode:e.mode}),{...s(t.thread?.id||null),currentTopic:t.clearTopic?void 0:e.currentTopic,topicLoading:t.clearTopic?{error:null,state:"loaded"}:e.topicLoading};case"HANDLE_EVENT_START":return(0,g.BI)("copilot.handle_event_start"),{...t.references?r(t.references):e,chatIsOpen:!0,chatIsVisible:!0,entryPointId:t.id};case"THREADS_LOADING":return m.W.reduceTelemetry||(0,g.BI)("copilot.threads_loading"),{...e,threadsLoading:{...e.threadsLoading,state:"loading"}};case"DISMISS_ATTACH_KNOWLEDGE_BASE_HERE_POPOVER":return(0,g.BI)("copilot.dismiss_attach_knowledge_base_here_popover"),{...e,renderAttachKnowledgeBaseHerePopover:!1};case"DISMISS_KNOWLEDGE_BASE_ATTACHED_TO_CHAT_POPOVER":return(0,g.BI)("copilot.dismiss_knowledge_base_attached_to_chat_popover"),{...e,renderKnowledgeBaseAttachedToChatPopover:!1};case"KNOWLEDGE_BASES_LOADING":return m.W.reduceTelemetry||(0,g.BI)("copilot.knowledge_bases_loading"),{...e,knowledgeBasesLoading:{...e.knowledgeBasesLoading,state:"loading"}};case"KNOWLEDGE_BASES_LOADED":return(0,g.BI)("copilot.knowledge_bases_loaded",{count:t.knowledgeBases.length}),{...e,knowledgeBases:t.knowledgeBases,knowledgeBasesLoading:{...e.knowledgeBasesLoading,state:"loaded",error:null}};case"KNOWLEDGE_BASES_LOADING_ERROR":return(0,g.BI)("copilot.knowledge_bases_loading_error",{error:t.message}),{...e,knowledgeBasesLoading:{...e.knowledgeBasesLoading,state:"error",error:t.message}};case"LATEST_THREAD_LOADED":return{...e,threads:new Map(e.threads.set(t.latestThread.id,t.latestThread))};case"THREADS_LOADED":return(0,g.BI)("copilot.threads_loaded",{count:t.threads.length,mode:e.mode}),{...e,threadsLoading:{...e.threadsLoading,state:"loaded"},threads:new Map(t.threads.map(e=>[e.id,e]))};case"THREADS_LOADING_ERROR":return(0,g.BI)("copilot.threads_loading_error",{error:t.message}),{...e,threadsLoading:{error:t.message,state:"error"}};case"DELETE_THREAD_KEEP_SELECTION":return(0,g.BI)("copilot.thread_deleted",{...y(t.thread),count:e.threads.size-1}),e.threads.delete(t.thread.id),{...s(null),threads:new Map(e.threads),threadsLoading:{...e.threadsLoading,state:"loaded"},messages:[],messagesLoading:{state:"loaded",error:null},currentReferences:[],currentView:"list"};case"DELETE_ALL_THREADS_KEEP_SELECTION":for(let s of t.threads)(0,g.BI)("copilot.thread_deleted",{...y(s),count:e.threads.size-1}),e.threads.delete(s.id);return{...s(null),threads:new Map(e.threads),threadsLoading:{...e.threadsLoading,state:"loaded"},messages:[],messagesLoading:{state:"loaded",error:null},currentReferences:[],currentView:"list"};case"DELETE_THREAD":if((0,g.BI)("copilot.thread_deleted",{...y(t.thread),count:e.threads.size-1,mode:e.mode}),e.threads.delete(t.thread.id),e.selectedThreadID===t.thread.id)return{...s(null),threads:new Map(e.threads),threadsLoading:{...e.threadsLoading,state:"loaded"},messages:[],messagesLoading:{state:"loaded",error:null},currentReferences:[]};return{...e,threads:new Map(e.threads)};case"DELETE_THREAD_ERROR":return(0,g.BI)("copilot.delete_thread_error",{...y(t.thread),error:t.error}),{...e,threadsLoading:{...e.threadsLoading,error:t.error},threads:new Map(e.threads.set(t.thread.id,t.thread))};case"DELETE_ALL_THREADS_ERROR":{for(let e of t.threads)(0,g.BI)("copilot.delete_thread_error",{...y(e),error:t.error});let s=new Map(e.threads);for(let e of t.threads)s.set(e.id,e);return{...e,threadsLoading:{...e.threadsLoading,error:t.error},threads:s}}case"MESSAGE_ADDED":return(0,g.BI)("copilot.message_added",{...f(t.message),count:e.messages.length+1,repoHasCustomInstructions:!!t.repoHasCustomInstructions,usedRepoCustomInstructions:!!t.usedRepoCustomInstructions}),{...e,messages:[...e.messages,t.message]};case"THREAD_UPDATED":return m.W.reduceTelemetry||(0,g.BI)("copilot.thread_updated",y(t.thread)),{...e,...s(t.thread.id),threads:new Map(e.threads.set(t.thread.id,t.thread))};case"REFERENCES_LOADED":return(0,g.BI)("copilot.references_loaded",{count:t.references.length}),{...e,currentReferences:t.references};case"ADD_REFERENCE":return(0,g.BI)("copilot.add_reference",{...T(t.reference),source:t.source,count:e.currentReferences.length+1}),{...e,...r([...e.currentReferences.filter(e=>!(0,p.x_)(e,t.reference)),t.reference])};case"REMOVE_REFERENCES":{let s=t.referenceIndexes.map(t=>e.currentReferences[t]).filter(e=>!!e);return s.length>0&&(0,g.BI)("copilot.remove_reference",{types:s.filter((e,s)=>t.referenceIndexes.includes(s)).map(e=>e.type).join(","),count:e.currentReferences.length-s.length}),{...r(e.currentReferences.filter((e,s)=>!t.referenceIndexes.includes(s)))}}case"SHOW_TOPIC_PICKER":return{...e,showTopicPicker:t.show};case"CURRENT_TOPIC_UPDATED":return t.topic&&(0,g.BI)("copilot.current_topic_updated",{type:t.topic?(0,p.P)(t.topic)?"docset":"repository":"none",mode:e.mode}),{...e,currentTopic:t.topic,topicLoading:{...e.topicLoading,state:t.state}};case"MESSAGE_STREAMING_STARTED":return m.W.reduceTelemetry||(0,g.BI)("copilot.message_streaming_started",{...f(t.message),count:e.messages.length}),{...e,isWaitingOnCopilot:!0,streamer:t.streamer,streamingMessage:t.message,messages:[...e.messages]};case"MESSAGE_STREAMING_TOKEN_ADDED":return{...e,streamingMessage:e.streamingMessage?{...e.streamingMessage,content:e.streamingMessage.content+t.token}:null};case"MESSAGE_STREAMING_FUNCTION_CALLED":if(e.streamingMessage){let s=e.streamingMessage.skillExecutions||[],r=s.findIndex(e=>"started"===e.status),a=r>=0?s[r]:null,n=s;switch(t.status){case"started":n=[...s,{slug:t.name,status:t.status,arguments:t.arguments,errorMessage:t.errorMessage,references:[]}];break;case"completed":a&&(n[r]={...a,status:t.status,references:t.references});break;case"error":a&&(n[r]={...a,status:t.status,errorMessage:t.errorMessage})}return{...e,streamingMessage:{...e.streamingMessage,skillExecutions:n}}}return e;case"MESSAGE_STREAMING_COMPLETED":{let s,r=e.defaultRecipient;return e.streamingMessage&&(r=S(s={...e.streamingMessage,id:t.messageResponse.id,references:t.messageResponse.references,createdAt:t.messageResponse.createdAt,intent:t.messageResponse.intent,copilotAnnotations:t.messageResponse.copilotAnnotations},e),(0,g.BI)("copilot.message_streaming_completed",{...f(s),...function(e){let t={totalTime:e.endTime-e.startTime};return void 0!==e.firstByte&&(t.ttfb=e.firstByte-e.startTime),void 0!==e.firstToken&&(t.ttft=e.firstToken-e.startTime),t}(t.timings),model:e.model?.id,mode:e.mode,count:e.messages.length+1})),{...e,defaultRecipient:r,isWaitingOnCopilot:!1,streamer:null,streamingMessage:null,messages:s?[...e.messages,s]:e.messages}}case"MESSAGE_STREAMING_FAILED":return(0,g.BI)("copilot.message_streaming_failed"),{...e,isWaitingOnCopilot:!1,streamer:null,streamingMessage:null};case"MESSAGE_STREAMING_STOPPED":{let t;return e.streamingMessage&&(t={...e.streamingMessage,interrupted:!0},(0,g.BI)("copilot.message_streaming_stopped",{...f(t),count:e.messages.length+1})),{...e,isWaitingOnCopilot:!1,streamer:null,streamingMessage:null,messages:t?[...e.messages,t]:e.messages}}case"MESSAGES_CLEAR_ERRORS":return{...e,streamingMessage:null,messages:[...e.messages.filter(e=>!e.error&&!e.interrupted)]};case"SELECT_REFERENCE":return t.reference&&(0,g.BI)("copilot.select_reference",T(t.reference)),{...e,selectedReference:t.reference};case"MODELS_LOADING":return{...e,modelsLoading:{state:"loaded",error:null}};case"MODELS_LOADING_ERROR":return{...e,modelsLoading:{state:"error",error:t.error}};case"MODELS_LOADED":return{...e,availableModels:t.models};case"SELECT_MODEL":if("immersive"!==e.mode)return e;return(0,g.BI)("copilot.select_model",{model:t.model?.name,mode:e.mode}),{...e,model:t.model};case"VIEW_ALL_THREADS":return{...e,currentView:"list"};case"VIEW_CURRENT_THREAD":return{...e,currentView:"thread"};case"IMPLICIT_CONTEXT_UPDATED":if(!(0,p.yR)(t.context,e.context))return{...e,context:t.context};return e;case"SET_TOP_REPOSITORIES":return{...e,topRepositoriesCache:t.topics};case"SET_AGENTS":return{...e,agents:t.agents};case"SET_CUSTOM_COPILOTS":return{...e,customCopilots:t.customCopilots};case"SET_CUSTOM_COPILOT_ID":return{...e,customCopilotId:t.customCopilotId};case"MESSAGE_STREAMING_CONFIRMATION":{let s={title:t.title,message:t.message,confirmation:t.confirmation};return{...e,streamingMessage:e.streamingMessage?{...e.streamingMessage,confirmations:e.streamingMessage.confirmations?[...e.streamingMessage.confirmations,s]:[s]}:null}}case"AGENT_ERROR":{let s=e.streamingMessage,r=t.error;return{...e,streamingMessage:s&&{...s,agentErrors:[...s.agentErrors??[],{type:r.type,code:r.code,message:r.message,identifier:r.identifier}]}}}case"ENTITLEMENT_UPDATED":return{...e,entitlement:t.entitlement??e.entitlement};case"TOGGLE_REPO_CUSTOM_INSTRUCTIONS":return{...e,repoCustomInstructionsEnabled:t.value};case"DISMISS_EDITOR_UPSELL_BANNER":return{...e,isEditorUpsellBannerDismissed:!0}}};function f(e){var t;if(!e)return(0,g.Ti)({});let s={id:e.id,role:e.role,createdAt:e.createdAt,threadID:e.threadID,referenceCount:e.references?.length??0};return e.intent&&(s.intent=e.intent),e.error&&(s.error=e.error),e.copilotAnnotations&&(s.copilotAnnotations=function(e){if(e)return{CodeVulnerability:e.CodeVulnerability?.map(e=>({details:{type:e?.details?.type}})),PublicCodeReference:e.PublicCodeReference?.map(e=>({details:{license:e?.details?.license,language:e?.details?.language}}))}}(e.copilotAnnotations)),e.skillExecutions&&(s.skillExecutions=(t=e.skillExecutions)?t.map(e=>({slug:e?.slug,status:e?.status,argumentCount:e?.arguments?.length??0,errorMessage:e?.errorMessage,references:e?.references?.length??0})):[]),e.interrupted&&(s.interrupted=!0),(0,g.Ti)(s)}function y(e){return e?(0,g.Ti)({id:e.id,createdAt:e.createdAt,updatedAt:e.updatedAt,currentReferenceCount:e.currentReferences?.length??0}):(0,g.Ti)({})}function T(e){return e?(0,g.Ti)({type:e.type}):(0,g.Ti)({})}function S(e,t){let s=(0,p.Th)(e,t.currentUserLogin);if("agent"===s.type)return s.name}var w=s(13369),C=s(91078),R=s(32645),v=s(79220);let I=(0,n.E7)(),D=(0,o.createContext)(null),A=(0,o.createContext)(null);function L({children:e,topic:t,login:s,apiURL:a,workerPath:n,threadId:i,refs:g,selectedReference:m,mode:f,ssoOrganizations:y,renderKnowledgeBases:T,renderAttachKnowledgeBaseHerePopover:S,renderKnowledgeBaseAttachedToChatPopover:v,customInstructions:D,chatIsOpen:L,chatIsVisible:O,chatVisibleSettingPath:b,renderBetaLabel:N,agentsPath:k,optedInToUserFeedback:P,agents:x,customCopilots:G,messages:U,testReducerState:B,reviewLab:W,realIp:F,currentView:H,hasCEorCBAccess:q,copilotUpsellBannerDismissed:J}){let{restoredMessages:K,restoredThreadTitle:j}=function(e,t){let s=u(e,t),r=d.getItem(h),a=r?JSON.parse(r):void 0;return((0,o.useEffect)(()=>{d.removeItem(h)},[]),s&&a?.expiry&&a.expiry>Date.now()&&a.threadId===e)?{restoredMessages:a.restoredMessages,restoredThreadTitle:a.threadTitle}:{}}(i,f),V=B||{threadsLoading:{state:"pending",error:null},messagesLoading:{state:"pending",error:null},messagesRestored:!!K,slashCommandLoading:{state:"pending",error:null},showTopicPicker:"immersive"!==f&&(!i||"assistive"===f)&&!t,topicLoading:{state:"pending",error:null},threads:new Map,restoredThreadTitle:j,knowledgeBasesLoading:{state:"pending",error:null},knowledgeBases:[],model:R.U,availableModels:[R.U],modelsLoading:{state:"pending",error:null},messages:U??K??[],streamer:null,streamingMessage:null,selectedThreadID:i,currentTopic:t,chatIsOpen:!!L,isWaitingOnCopilot:!1,currentUserLogin:s,apiUrl:a,currentReferences:g,findFileWorkerPath:n,currentView:H||"thread",selectedReference:m??null,mode:f,currentRepository:(0,p.Z6)(t)?t:void 0,ssoOrganizations:y,context:void 0,renderKnowledgeBases:T??!0,renderAttachKnowledgeBaseHerePopover:S,renderKnowledgeBaseAttachedToChatPopover:v,customInstructions:D,chatIsVisible:O,chatVisibleSettingPath:b,renderBetaLabel:N,topRepositoriesCache:void 0,agentsPath:k,optedInToUserFeedback:P,agents:x,customCopilots:G,customCopilotId:void 0,suggestionsDismissed:!1,reviewLab:W,repoCustomInstructionsEnabled:E.J.getRepoCustomInstructionsState(),isEditorUpsellBannerDismissed:J},[z,$]=(0,o.useReducer)(_,V);return!function(e,t,s,r){let a=u(t,r);(0,o.useEffect)(()=>{if(!a)return;let r=()=>{if(!e?.length||!t)return;let r=s.get(t),a=r?.name,n={expiry:Date.now()+8e3,restoredMessages:e,threadId:t,threadTitle:a};d.setItem(h,JSON.stringify(n))};return window.addEventListener("turbo:before-fetch-response",r),window.addEventListener("beforeunload",r),window.addEventListener("popstate",r),()=>{window.removeEventListener("turbo:before-fetch-response",r),window.removeEventListener("beforeunload",r),window.removeEventListener("popstate",r)}},[e,a,t,s])}(z.messages,z.selectedThreadID,z.threads,z.mode),(0,r.jsx)(c.$,{mode:z.mode,children:(0,r.jsx)(M,{state:z,children:(0,r.jsx)(A.Provider,{value:$,children:(0,r.jsx)(C.v,{apiURL:a,state:z,dispatch:$,ssoOrganizations:y,realIp:F,hasCEorCBAccess:q,children:(0,r.jsx)(w.A,{children:(0,r.jsx)(l.RelayEnvironmentProvider,{environment:I,children:e})})})})})})}let O=(0,o.createContext)(null);function M({state:e,children:t}){let s=(0,a.AI)(e);return(0,i.N)(()=>{s.value=e},[e,s]),(0,r.jsx)(v.sw,{value:s,children:(0,r.jsx)(O.Provider,{value:e,children:t})})}function b(){let e=(0,o.useContext)(O);if(!e)throw Error("useChatState can only be used inside a CopilotChatProvider");return e}function N(e){let t=(0,v.rE)();if(!t)throw Error("useChatStateLens can only be used inside a CopilotChatProvider");let s=(0,a.Sk)(t,e);return(0,a.HN)(s)}function k(e){return N(t=>t[e])}function P(...e){return N(t=>(function(e,t){let s={};for(let r of t)s[r]=e[r];return s})(t,e))}function x(){return(0,o.useContext)(D)}try{D.displayName||(D.displayName="ChatPanelReferenceContext")}catch{}try{A.displayName||(A.displayName="CopilotChatDispatchContext")}catch{}try{L.displayName||(L.displayName="CopilotChatProvider")}catch{}try{O.displayName||(O.displayName="ChatStateContext")}catch{}try{M.displayName||(M.displayName="ChatStateProvider")}catch{}},91078:(e,t,s)=>{s.d(t,{b:()=>h,v:()=>u});var r=s(74848),a=s(70170),n=s(96540),i=s(87352),o=s(57938),l=s(88365),c=s(79220);let d=(0,n.createContext)(null);function u({apiURL:e,state:t,dispatch:s,ssoOrganizations:u,children:h,realIp:p,hasCEorCBAccess:g}){let m=(0,c.tD)(),E=(0,n.useMemo)(()=>new i.e8(s,e,u,m,p,void 0,g),[s,e,u,m,p,g]);return(0,n.useEffect)(()=>{t.chatIsOpen&&(async()=>{if(t.selectedThreadID&&t.messages.length>0&&!t.currentTopic){let e=l.J.getSelectedTopic(t.selectedThreadID),s=Number(e);e&&!isNaN(s)?await E.fetchCurrentRepo(s):E.clearCurrentTopic()}})()},[t.selectedThreadID,E,t.messages.length,t.currentTopic,t.chatIsOpen]),(0,n.useEffect)(()=>{let e=async()=>{let e=window.location.hash,t=window.location.pathname,s=window.location.hash?`${t}${e}`:t,r=s.slice(1).split("/");if(r.length<2)return;let a=r[0],n=r[1];a&&n&&await E.fetchImplicitContext(s,a,n)},s=(0,a.s)(()=>{e()},500);o.W.implicitContext&&t.chatIsOpen&&(s(),function(){let{replaceState:e}=window.history;window.history.replaceState=function(...t){e.apply(window.history,t),window.dispatchEvent(new Event("replaceState"))},window.addEventListener("popstate",s),window.addEventListener("replaceState",s),()=>{window.removeEventListener("popstate",s),window.removeEventListener("replaceState",s)}}())},[E,t.chatIsOpen]),(0,r.jsx)(d.Provider,{value:E,children:h})}function h(){let e=(0,n.useContext)(d);if(!e)throw Error("useChatManager must be used within a CopilotChatManagerProvider");return e}try{d.displayName||(d.displayName="CopilotChatManagerContext")}catch{}try{u.displayName||(u.displayName="CopilotChatManagerProvider")}catch{}},79220:(e,t,s)=>{s.d(t,{rE:()=>o,sw:()=>n,tD:()=>i});var r=s(96540);let a=(0,r.createContext)(null),n=a.Provider;function i(){let e=(0,r.useContext)(a);if(!e)throw Error("useGetChatState can only be used inside a CopilotChatProvider");return(0,r.useCallback)(()=>e.value,[e])}function o(){return(0,r.useContext)(a)}try{a.displayName||(a.displayName="ObservableChatStateContext")}catch{}}}]);
//# sourceMappingURL=ui_packages_copilot-chat_utils_copilot-chat-hooks_ts-ui_packages_issue-viewer_utils_queries_ts-9e72f66a3965.js.map